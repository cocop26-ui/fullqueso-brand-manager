<!DOCTYPE html>
<html lang="es-MX">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Full Queso - AI Cashier con Claude</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 1600px;
            width: 95%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            height: 90vh;
        }

        .left-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .avatar-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin-bottom: 20px;
        }

        .avatar {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .face {
            width: 80%;
            height: 80%;
            background: #f8f9fa;
            border-radius: 50%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .eyes {
            display: flex;
            gap: 60px;
            position: absolute;
            top: 35%;
        }

        .eye {
            width: 30px;
            height: 30px;
            background: #333;
            border-radius: 50%;
            position: relative;
            animation: blink 3s infinite;
        }

        @keyframes blink {
            0%, 48%, 52%, 100% { height: 30px; }
            50% { height: 4px; }
        }

        .mouth {
            width: 80px;
            height: 40px;
            border: 4px solid #333;
            border-top: none;
            border-radius: 0 0 80px 80px;
            position: absolute;
            bottom: 25%;
            transition: all 0.3s;
        }

        .mouth.talking {
            animation: talk 0.3s infinite;
        }

        @keyframes talk {
            0%, 100% { height: 40px; }
            50% { height: 20px; }
        }

        .status {
            font-size: 18px;
            color: #667eea;
            font-weight: bold;
            margin: 20px 0;
            text-align: center;
        }

        .mic-button {
            width: 80px;
            height: 80px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 32px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .mic-button.listening {
            background: #ff6b6b;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .right-panel {
            display: flex;
            flex-direction: column;
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .order-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            flex-grow: 1;
            overflow-y: auto;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            color: #333;
        }

        .item-price {
            color: #667eea;
            font-weight: bold;
        }

        .remove-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
        }

        .total-section {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .total-amount {
            font-size: 36px;
            font-weight: bold;
        }

        .config-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .config-section h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .config-section input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        .config-section button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
        }

        .empty-order {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .products-panel {
            display: flex;
            flex-direction: column;
        }

        .products-panel h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            overflow-y: auto;
            padding: 10px;
        }

        .product-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .product-image {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            margin-bottom: 10px;
        }

        .product-name {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .product-price {
            color: #667eea;
            font-weight: bold;
            font-size: 16px;
        }

        .claude-indicator {
            background: #10a37f;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 10px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
            .products-panel {
                grid-column: span 2;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .products-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-panel">
            <div class="avatar-container">
                <div class="avatar">
                    <div class="face">
                        <div class="eyes">
                            <div class="eye"></div>
                            <div class="eye"></div>
                        </div>
                        <div class="mouth" id="mouth"></div>
                    </div>
                </div>
            </div>
            <div class="status" id="status">üé§ Inicializando...</div>
            <button class="mic-button listening" id="micButton">üé§</button>
            <div class="claude-indicator">ü§ñ Powered by Claude AI via Firebase</div>
        </div>

        <div class="right-panel">
            <h1>üßÄ Full Queso</h1>

            <div class="order-section" id="orderList">
                <div class="empty-order">
                    Tu pedido aparecer√° aqu√≠
                </div>
            </div>

            <div class="total-section">
                <div>Total</div>
                <div class="total-amount" id="totalAmount">$0</div>
            </div>
        </div>

        <div class="products-panel">
            <h2>üçΩÔ∏è Men√∫</h2>
            <div class="products-grid" id="productsGrid">
                <!-- Products will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Full Queso Menu
        const menu = [
            { id: 1, name: "Teque√±os Bites x6", price: 8.5, emoji: "üßÄ", keywords: ["teque√±os", "tequenos", "bites", "queso", "seis"] },
            { id: 2, name: "Teque√±os Bites x12", price: 15.0, emoji: "üßÄ", keywords: ["teque√±os", "tequenos", "bites", "doce", "docena"] },
            { id: 3, name: "Teque√±os Party Box", price: 35.0, emoji: "üéâ", keywords: ["teque√±os", "tequenos", "party", "box", "fiesta"] },
            { id: 4, name: "Churros Cl√°sicos x3", price: 6.0, emoji: "ü•®", keywords: ["churros", "clasicos", "tres"] },
            { id: 5, name: "Churros Cl√°sicos x6", price: 11.0, emoji: "ü•®", keywords: ["churros", "clasicos", "seis"] },
            { id: 6, name: "Churros con Cajeta", price: 7.5, emoji: "üçØ", keywords: ["churros", "cajeta", "dulce", "caramelo"] },
            { id: 7, name: "Churros con Chocolate", price: 7.5, emoji: "üç´", keywords: ["churros", "chocolate"] },
            { id: 8, name: "Helado Sundae Chocolate", price: 6.5, emoji: "üç®", keywords: ["helado", "sundae", "chocolate", "postre"] },
            { id: 9, name: "Helado Sundae Vainilla", price: 6.5, emoji: "üç¶", keywords: ["helado", "sundae", "vainilla", "vanilla", "postre"] },
            { id: 10, name: "Helado Sundae Fresa", price: 6.5, emoji: "üçì", keywords: ["helado", "sundae", "fresa", "strawberry", "postre"] },
            { id: 11, name: "Copa de Helado", price: 5.5, emoji: "üçß", keywords: ["copa", "helado", "postre"] },
            { id: 12, name: "Queso Blanco Prensado 250g", price: 9.0, emoji: "üßà", keywords: ["queso", "blanco", "prensado", "venezolano"] },
            { id: 13, name: "Queso Blanco Prensado 500g", price: 17.0, emoji: "üßà", keywords: ["queso", "blanco", "prensado", "medio", "kilo"] },
            { id: 14, name: "Combo Familiar", price: 2.8, emoji: "üéÅ", keywords: ["combo", "familiar", "teque√±os", "churros"] },
            { id: 15, name: "Combo Postre", price: 1.2, emoji: "üç∞", keywords: ["combo", "postre", "churros", "helado"] },
            { id: 16, name: "Agua Natural", price: 2.0, emoji: "üíß", keywords: ["agua", "natural", "water"] },
            { id: 17, name: "Refresco", price: 3.0, emoji: "ü•§", keywords: ["refresco", "soda", "coca"] },
            { id: 18, name: "Jugo Natural", price: 4.5, emoji: "üßÉ", keywords: ["jugo", "natural", "juice"] },
        ];

        let order = [];
        let recognition;
        let isListening = false;
        let autoListenMode = true;
        let currentCustomer = null;
        let conversationHistory = [];

        // Firebase Function URL - NO NEED FOR API KEY!
        const FIREBASE_FUNCTION_URL = 'https://us-central1-fullqueso-bot.cloudfunctions.net/kioskClaudeProxy';

        // DOM Elements
        const micButton = document.getElementById('micButton');
        const status = document.getElementById('status');
        const mouth = document.getElementById('mouth');
        const orderList = document.getElementById('orderList');
        const totalAmount = document.getElementById('totalAmount');

        // Call Claude via Firebase Function
        async function callClaude(userMessage) {
            console.log('üî• Calling Firebase Function...');

            try {
                // Build system prompt with menu and context
                const systemPrompt = `Eres Anajensy, una asistente virtual amigable y profesional de Full Queso, un restaurante venezolano especializado en teque√±os, churros, helados y queso artesanal.

TU PERSONALIDAD:
- Hablas en espa√±ol de manera natural y c√°lida
- Eres eficiente pero amable
- Usas un tono venezolano amigable
- Siempre confirmas informaci√≥n importante

TU TRABAJO:
1. Saludar cordialmente a los clientes
2. Recopilar datos del cliente (nombre, ID, n√∫mero de celular)
3. Tomar pedidos del men√∫
4. Confirmar pedidos antes de procesar
5. Recoger feedback del cliente

MEN√ö DISPONIBLE:
${menu.map(item => `- ${item.name}: $${formatPrice(item.price)}`).join('\n')}

DATOS DEL CLIENTE ACTUAL:
${currentCustomer ? `Nombre: ${currentCustomer.name}
ID: ${currentCustomer.idNumber || 'No proporcionado'}
Tel√©fono: ${currentCustomer.phone || 'No proporcionado'}
Visitas anteriores: ${currentCustomer.visitCount || 1}
${currentCustomer.favoriteItems ? 'Favoritos: ' + Object.keys(currentCustomer.favoriteItems).slice(0, 2).join(', ') : ''}` : 'Cliente nuevo - a√∫n no se han recopilado datos'}

PEDIDO ACTUAL:
${order.length > 0 ? order.map(item => `- ${item.name}: $${formatPrice(item.price)}`).join('\n') : 'Ning√∫n producto agregado'}
Total actual: $${formatPrice(order.reduce((sum, item) => sum + item.price, 0))}

INSTRUCCIONES IMPORTANTES:
1. Si no tienes el nombre del cliente, preg√∫ntalo primero
2. Despu√©s del nombre, solicita el n√∫mero de identificaci√≥n
3. Luego solicita el n√∫mero de celular
4. Una vez tengas los datos, procede a tomar el pedido
5. Cuando el cliente diga un producto, conf√≠rmalo
6. Si no entiendes, pide clarificaci√≥n
7. Cuando el cliente termine, pregunta si desea algo m√°s
8. Al finalizar, pide su opini√≥n sobre Full Queso

FORMATO DE RESPUESTA JSON:
Debes responder SIEMPRE en formato JSON con esta estructura:
{
  "response": "Tu respuesta en espa√±ol para el cliente",
  "action": "greeting|collect_name|collect_id|collect_phone|add_item|remove_item|confirm_order|finish_order|collect_feedback|none",
  "data": {
    "name": "nombre del cliente si lo mencion√≥",
    "idNumber": "ID si lo mencion√≥",
    "phone": "tel√©fono si lo mencion√≥",
    "item": "nombre exacto del producto del men√∫ si mencion√≥ uno",
    "feedback": "comentario del cliente si dio feedback"
  }
}

Responde SOLO con el JSON, sin texto adicional.`;

                // Add user message to history
                conversationHistory.push({
                    role: 'user',
                    content: userMessage
                });

                console.log('üì§ Sending to Firebase Function...');

                const response = await fetch(FIREBASE_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        messages: conversationHistory,
                        systemPrompt: systemPrompt
                    })
                });

                console.log('üì• Response status:', response.status);

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('‚ùå Firebase Function error:', errorData);
                    throw new Error(`Function error: ${response.status} - ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                console.log('üì¶ Full response:', data);

                if (!data.success) {
                    throw new Error(data.error || 'Unknown error');
                }

                const claudeResponse = data.response;
                console.log('üí¨ Claude text response:', claudeResponse);

                // Add Claude response to history
                conversationHistory.push({
                    role: 'assistant',
                    content: claudeResponse
                });

                // Parse JSON response
                try {
                    const parsedResponse = JSON.parse(claudeResponse);
                    return parsedResponse;
                } catch (e) {
                    console.error('Failed to parse Claude JSON:', e);
                    return {
                        response: claudeResponse,
                        action: 'none',
                        data: {}
                    };
                }

            } catch (error) {
                console.error('Error calling Claude API:', error);
                return {
                    response: 'Lo siento, tuve un problema procesando tu solicitud. ¬øPuedes repetir?',
                    action: 'none',
                    data: {}
                };
            }
        }

        // Process voice command with Claude
        async function processVoiceCommand(transcript) {
            console.log('üé§ Procesando con Claude:', transcript);
            console.log('üìå API Key presente:', CLAUDE_API_KEY ? 'S√ç' : 'NO');
            status.textContent = 'ü§î Pensando...';

            const claudeResponse = await callClaude(transcript);

            console.log('‚úÖ Respuesta de Claude:', claudeResponse);

            // Handle actions
            if (claudeResponse.data) {
                // Collect customer data
                if (claudeResponse.data.name && (!currentCustomer || !currentCustomer.name)) {
                    if (!currentCustomer) currentCustomer = {};
                    currentCustomer.name = claudeResponse.data.name;
                }

                if (claudeResponse.data.idNumber) {
                    currentCustomer.idNumber = claudeResponse.data.idNumber;
                }

                if (claudeResponse.data.phone) {
                    currentCustomer.phone = claudeResponse.data.phone;
                    // Check if returning customer
                    const existingCustomer = getCustomer(claudeResponse.data.phone);
                    if (existingCustomer) {
                        currentCustomer = existingCustomer;
                    } else {
                        saveCustomer(currentCustomer);
                    }
                }

                // Add item to order
                if (claudeResponse.data.item && claudeResponse.action === 'add_item') {
                    const foundItem = menu.find(item =>
                        item.name.toLowerCase().includes(claudeResponse.data.item.toLowerCase()) ||
                        claudeResponse.data.item.toLowerCase().includes(item.name.toLowerCase())
                    );

                    if (foundItem) {
                        order.push({ ...foundItem });
                        updateOrderDisplay();
                    }
                }

                // Save feedback
                if (claudeResponse.data.feedback) {
                    if (currentCustomer && currentCustomer.phone) {
                        let customers = JSON.parse(localStorage.getItem('fullQuesoCustomers') || '{}');
                        if (!customers[currentCustomer.phone].feedback) {
                            customers[currentCustomer.phone].feedback = [];
                        }
                        customers[currentCustomer.phone].feedback.push({
                            date: new Date().toISOString(),
                            comment: claudeResponse.data.feedback
                        });
                        localStorage.setItem('fullQuesoCustomers', JSON.stringify(customers));
                    }
                }
            }

            // Handle finish order
            if (claudeResponse.action === 'finish_order' && order.length > 0) {
                if (currentCustomer && currentCustomer.phone) {
                    updateCustomerPreferences(currentCustomer.phone, order);
                }
            }

            // Speak Claude's response
            speak(claudeResponse.response);
        }

        // Initialize Speech Recognition
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.lang = 'es-MX';
            recognition.continuous = true;
            recognition.interimResults = false;

            recognition.onstart = () => {
                isListening = true;
                console.log('üé§ Listening...');
            };

            recognition.onresult = (event) => {
                const resultIndex = event.results.length - 1;
                const transcript = event.results[resultIndex][0].transcript.toLowerCase().trim();
                const confidence = event.results[resultIndex][0].confidence;

                console.log('Escuchado:', transcript, 'Confianza:', confidence);

                if (confidence > 0.5) {
                    processVoiceCommand(transcript);
                }
            };

            recognition.onerror = (event) => {
                if (event.error !== 'no-speech') {
                    console.error('Recognition error:', event.error);
                }

                if (event.error !== 'not-allowed' && event.error !== 'service-not-allowed') {
                    setTimeout(() => {
                        if (autoListenMode && !isListening) {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.error('Error restarting:', e);
                            }
                        }
                    }, 1000);
                }
            };

            recognition.onend = () => {
                isListening = false;
                if (autoListenMode) {
                    setTimeout(() => {
                        try {
                            recognition.start();
                        } catch (e) {
                            console.error('Error restarting:', e);
                        }
                    }, 300);
                }
            };
        }

        // Customer Database Functions
        function saveCustomer(customer) {
            let customers = JSON.parse(localStorage.getItem('fullQuesoCustomers') || '{}');
            customers[customer.phone] = {
                ...customer,
                lastVisit: new Date().toISOString(),
                visitCount: (customers[customer.phone]?.visitCount || 0) + 1
            };
            localStorage.setItem('fullQuesoCustomers', JSON.stringify(customers));
        }

        function getCustomer(phone) {
            let customers = JSON.parse(localStorage.getItem('fullQuesoCustomers') || '{}');
            return customers[phone] || null;
        }

        function updateCustomerPreferences(phone, orderItems) {
            let customers = JSON.parse(localStorage.getItem('fullQuesoCustomers') || '{}');
            if (customers[phone]) {
                if (!customers[phone].favoriteItems) {
                    customers[phone].favoriteItems = {};
                }
                orderItems.forEach(item => {
                    customers[phone].favoriteItems[item.name] =
                        (customers[phone].favoriteItems[item.name] || 0) + 1;
                });
                localStorage.setItem('fullQuesoCustomers', JSON.stringify(customers));
            }
        }

        // Format price
        function formatPrice(price) {
            if (price % 1 === 0) {
                return price.toString();
            } else {
                return price.toFixed(2).replace('.', ',').replace(/,?0+$/, '');
            }
        }

        // Update Order Display
        function updateOrderDisplay() {
            if (order.length === 0) {
                orderList.innerHTML = '<div class="empty-order">Tu pedido aparecer√° aqu√≠</div>';
                totalAmount.textContent = '$0';
                return;
            }

            let html = '';
            let total = 0;

            order.forEach((item, index) => {
                total += item.price;
                html += `
                    <div class="order-item">
                        <span class="item-name">${item.name}</span>
                        <span>
                            <span class="item-price">$${formatPrice(item.price)}</span>
                            <button class="remove-btn" onclick="removeItem(${index})">‚úï</button>
                        </span>
                    </div>
                `;
            });

            orderList.innerHTML = html;
            totalAmount.textContent = `$${formatPrice(total)}`;
        }

        // Remove Item
        function removeItem(index) {
            order.splice(index, 1);
            updateOrderDisplay();
        }

        // Text to Speech
        let selectedVoice = null;

        function loadVoices() {
            const voices = speechSynthesis.getVoices();
            selectedVoice = voices.find(voice =>
                (voice.lang.startsWith('es') && voice.name.includes('Female')) ||
                (voice.lang.startsWith('es') && voice.name.includes('M√≥nica')) ||
                (voice.lang.startsWith('es') && voice.name.includes('Paulina'))
            ) || voices.find(voice => voice.lang.startsWith('es'));
            console.log('Selected voice:', selectedVoice?.name);
        }

        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices();

        function speak(text) {
            status.textContent = `üó£Ô∏è ${text}`;

            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-MX';
                utterance.rate = 0.95;
                utterance.pitch = 1.1;
                utterance.volume = 1.0;

                if (selectedVoice) {
                    utterance.voice = selectedVoice;
                }

                utterance.onstart = () => {
                    mouth.classList.add('talking');
                };

                utterance.onend = () => {
                    mouth.classList.remove('talking');
                    setTimeout(() => {
                        status.textContent = 'üé§ Escuchando continuamente...';
                    }, 500);
                };

                speechSynthesis.speak(utterance);
            }
        }

        // Display products
        function displayProducts() {
            const productsGrid = document.getElementById('productsGrid');
            productsGrid.innerHTML = '';

            menu.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.onclick = () => addProductById(product.id);

                productCard.innerHTML = `
                    <div class="product-image">${product.emoji}</div>
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">$${formatPrice(product.price)}</div>
                `;

                productsGrid.appendChild(productCard);
            });
        }

        function addProductById(productId) {
            const product = menu.find(item => item.id === productId);
            if (product) {
                order.push({ ...product });
                updateOrderDisplay();
                speak(`Agregado: ${product.name}`);
            }
        }

        // Initialize microphone
        async function initializeMicrophone() {
            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log('‚úÖ Microphone granted');

                if (recognition) {
                    recognition.start();
                }

                setTimeout(() => {
                    speak('¬°Hola! Bienvenido a Full Queso. Soy Anajensy, tu asistente virtual inteligente. ¬øC√≥mo te llamas?');
                }, 1000);

            } catch (error) {
                console.error('Microphone denied:', error);
                status.textContent = '‚ùå Se requiere acceso al micr√≥fono';
            }
        }

        // Initialize
        window.addEventListener('load', () => {
            displayProducts();

            setTimeout(() => {
                initializeMicrophone();
            }, 500);
        });
    </script>
</body>
</html>
